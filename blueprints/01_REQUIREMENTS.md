# シーン

ゲームプレイをシーンに分けて記述していく。

## タイトルシーン

wasdかゲームパッドによるカーソル移動で選択する。

- はじめる→ステージ1に遷移
- ステージ選択
- オプション
- やめる-アプリケーション終了

### ステージ選択

フローティングウィンドウでタイトルの上に描画

複数のステージ(計5つ程度)が存在

フォーカス移動でステージ選択。カーソルを合わせた状態でキーボードの{Space}、もしくはゲームパッドの{Aボタン}を押すことによってステージを開始する。

ESCを押すことによってフローティングウィンドウを閉じる。

### オプション

フローティングウィンドウで表示、ESCで閉じる。全項目即時反映。

- BGM音量 (100% default, チェックボックスでオンオフ可能)
- SE音量 (同上)
- 画質（exe版のみ）(スクリーンサイズ、ウィンドウ/フルスクリーン切り替え)

## ゲームシーン

ゲームシーンの開始と同時に(紙芝居データがあるのなら)紙芝居のようなストーリー描写を開始

その後バトルが開始。ボスを撃破するとバトル終了

終了後(紙芝居データがあるのなら)再度紙芝居が開始

ゲームシーン終了後はタイトルシーンに戻り、ステージ選択ウィンドウを自動表示する。

ゲームシーン中は常にポーズ可能、ただしゲームオーバー中は不可

### 紙芝居

紙芝居はSpaceキーによって進めることができる。

紙芝居の画面情報は一枚絵と文章(キャラクターのセリフや地の文)の二種

### バトル

バトルではボスキャラを倒すことが目標。

「戦闘」開始からボスの攻撃が始まり、ボスの各HPゲージを削り取っていき、最終的に全ゲージを0にすればバトル終了。

画面上には自機、ロボット、アイテム、敵、背景、UIが存在する

- **バトルシステム**
    
    バトルの進行を管理する。
    
    バトルで行われるイベントには以下のものがある。
    
    - バトル開始
        
        バトル開始ではバトル関連の開始処理が行われる。ボスや自機、ロボット、背景を画面上に表示する。自機の操作は不能。
        
        基本的にバトルシーンに入った直後に行われる。
        
        バトル開始が終了する際、「会話」がない場合はボス起動に遷移、「会話」がある場合は「会話」に遷移する。
        
    - 会話
        
        ボスとプレイヤーの会話が発生する。{Space}でログを送る。
        
        「バトル開始」から「会話」は起動される。
        
        「会話」終了時「ボス起動」に遷移。
        
    - ボス起動
        
        タイトルを表示。タイトル表示終了後にボスが起動する。ボスの起動時にはボスHP表示等が行われる。
        
        「ボス起動」終了時「戦闘」に遷移。
        
    - 戦闘
        
        ボスとの戦闘を行う。自機、ロボット、アイテム、ボスが動作可能になる。
        
        ボスの全HPゲージを0にした場合「ボス撃破」に遷移。
        
    - ボス撃破
        
        ボスのHPが削りきられた際に開始する。撃破演出やリザルトを表示する。
        
        終了時、別の会話が登録されていた場合はこれを開始する。
        
    - バトル終了
        
        バトルを終了する。
        
    - ゲームオーバー
        
        「戦闘中」自機のHPが0になったとき、ゲームオーバーになる。
        
        ゲームオーバーから任意のタイミングでUI上から以下を選択、遷移可能。
        
        - リトライ-再度「ボス起動」からやり直す。自機やボスは初期状態に戻る。
        - ステージ選択に戻る-タイトルシーンに遷移し、ステージ選択ウィンドウを自動表示
    - ポーズ
        
        「ゲームオーバー」中以外でESCを押すことでポーズされる。
        
        ポーズでは自機、敵、アイテム、Bullet、ロボット、パーティクル、ポーズUI以外のSEの動作が停止する。ただしBGMは流れ続ける。
        
        紙芝居/会話中もポーズ可能。ポーズ中はテキスト進行・演出も停止する。
        
        ポーズからは任意のタイミングでUI上から以下を選択、遷移可能。
        
        - 再開-「戦闘」の各種動作を起動し、ポーズUIが見えなくなる。
        - リトライ-「ボス起動」からやり直す。自機やボスは初期状態に戻る。これは「戦闘」中にポーズした場合のみ表示。
        - ステージ選択に戻る-タイトルシーンに遷移し、ステージ選択ウィンドウを自動表示
        
    
- **自機**
    
    自機はロボット上を移動可能
    
    歩行は{wasd}キーまたは{ゲームパッドのスティック}、{十字キー}で開始。{unknown}の速度で移動。
    
    ダッシュは敵の弾幕をエネルギーとして吸収し、雑魚敵を一撃で倒しエネルギーを得る。
    
    ダッシュは{Space}で開始。{unkown}の速度で移動。減速率は{unknown}。攻撃持続時間は{unknown}。クールタイムは{unknown}。
    
    ダッシュ中はすべての敵、弾幕を貫通する。
    
    触れた弾幕、雑魚敵を全てエネルギーとして吸収する。このエネルギー量はEnemyBullet、雑魚敵内パラメータ取得可能エネルギーに対応する。吸収した弾は消失する。吸収可能期間は無敵状態。
    ダッシュ中にBOSSに触れることでダメージを与えることができる。
    
    攻撃アイコンの起動はステージ上のボタンを押すことで開始。
    
    敵か弾幕に接触するとダメージを受ける。以後{3秒間}無敵。
    
    **静的パラメータ**
    
    - HP最大
    - エネルギー最大
    - エネルギー特殊最大-{最大3個}
    - 歩行基本速度
    - 衝突後無敵時間
    - ダッシュ基本速度
    - ダッシュ減速率
    - ダッシュクールタイム
    - ダッシュ攻撃持続時間
    - ダッシュ威力-ボスに衝突した際の攻撃威力
    - 敵弾幕に対する当たり判定
    - ダッシュ中の当たり判定
    
    **動的パラメータ**
    
    - HP現在
    - エネルギー量現在
    - エネルギー特殊現在
- **ロボット**
    
    ロボットは自機の動ける範囲。計5つの攻撃/特殊攻撃アイコンが固定配置。
    
    4つは攻撃アイコン、1つが特殊攻撃アイコン。
    
    ロボット内は壁に囲まれている。迷路のように壁があり、これを自機は通り抜けることができない。また、通常の壁に対して敵、敵弾幕、見方弾幕は一切衝突しない。
    
    点灯中の攻撃アイコン前に存在する床のスイッチが踏まれると、ロボットは攻撃シーケンスを開始。
    
    - **攻撃シーケンス**
        
        各攻撃シーケンスはプレイヤーの保持する一定量のエネルギーを消費して攻撃アイコンが消灯し、開始される。
        
        攻撃アイコンは通常時消灯。必要エネルギーが集まっておりかつそのアイコンが使用中でない、つまり使用可能状態であるときは点灯
        
        攻撃シーケンスは開始、攻撃、終了の三つから構成される。
        
        攻撃フェーズでは攻撃用オブジェクト**Bullet**を召喚+動作させる。
        
        攻撃シーケンス終了後使用可能状態であるときは再度攻撃アイコンが点灯する。
        
        **共通静的パラメータ**
        
        - 使用エネルギー
        - 時間開始-開始フェーズの持続時間
        - 時間攻撃-攻撃フェーズの持続時間
        - 時間終了-終了フェーズの持続時間
    - **特殊攻撃シーケンス**
        
        特殊エネルギーを使用して発動する高威力の攻撃シーケンス。
        
        発動には特殊エネルギーを{1つ}使用する。
        
        発動に特殊エネルギーを使用する以外は攻撃シーケンスと同一。
        
    - BulletRobot
        
        BulletRは攻撃用オブジェクトであり、敵に衝突することでダメージを与える。
        
        消失フラグがついていれば敵に衝突後に消滅する。
        
        BulletRは画面外に出るか一定時間後に消滅する。
        
        **共通静的パラメータ**
        
        - 威力
        - 寿命
        - 消失フラグ
        - ドロップ倍率-攻撃によっては敵のドロップするアイテム量が増減する。例えば威力小の連続攻撃ではドロップ倍率を下げることでエネルギー量を調整する。
    - アイテムドロップ
        
        ロボット内ではアイテムが発生する。
        
        エネルギーが最も多く発生する。回復薬などその他のアイテムも発生する。
        
        回復アイテムはプレイヤーのHPが{2割}を下回ったらロボット内のどこかにドロップする。ただし連続ではドロップせず、一度ドロップしたらクールタイムを{30秒}設ける。ドロップ判定は被弾時に発生。
        
    
- **アイテム**
    
    重なるだけで取得 アイテムの円/矩形の当たり判定が自機の当たり判定に触れたら取得
    
    同じ位置に重なることもある
    
    ただし画面内に存在できる数はそれぞれ限定する。回復薬は{3個}、無敵アイテムは{2個}、エネルギーは{200}個。これを超えたら古いものから削除していく。
    
    エネルギーはObjectPoolで実装。
    
    - 回復薬
        - 静的パラメータ
            - 回復HP量
    - 無敵アイテム
        - 静的パラメータ
            - 効果時間
    - エネルギー
        
        エネルギーはロボットの攻撃アイコンの起動にのみ使用される。
        
        エネルギーは重なると合成される。
        
        見た目が変わるだけで回復量は「基本量」*「重なった数」
        
        - 静的パラメータ
            - 回復エネルギー量
    - 特殊エネルギー
        
        特殊エネルギーはゲージ破壊時に確率ドロップ、専用の敵を撃破時にドロップ等(詳細未定義)
        
        特殊エネルギーはロボットの特殊攻撃アイコンの起動にのみ使用される。
        

- **敵**
    - 雑魚敵
        - ダッシュによって一撃で撃破可能。攻撃アイコンによる攻撃もhpを減らせる。
        - ダッシュで倒すとアイテムを直接入手できる
        - ダッシュ以外だとステージにランダムに散らばる、ただし重み付きランダムでロボット前方のほうに落ちやすい
        - 共通静的パラメータ
            - 最大HP
            - 攻撃力
            - アイテムドロップ率 [{”id”, “rate”}] （レートは100を超えてもいい）
            - 吸収可能エネルギー
        - 共通動的パラメータ
            - 現在HP
        
    - BOSS
        - 基本ロボットの外、画面右側にいる
        - 攻撃するとエネルギーを落とす（基礎ドロップ量ｘ攻撃のドロップ倍率によってエネルギードロップ量を計算）ただし制限として{0.1秒}に一回まで
        - HPは複数のHPゲージに分かれている。また、各HPゲージにより最大量は異なる。
        - フェーズはゲージを削り切ることによって切り替わる。
        - フェーズによって攻撃パターンが変化
        - 共通静的パラメータ
            - [最大HP]-各ゲージの最大HP
            - フェーズ数-HPゲージの本数と一致する。
            - 基礎ドロップ量
        
        - 共通動的パラメータ
            - 現在HP
            - 現在フェーズ
        
        ### 攻撃シーケンス
        
        - フェーズ１つ=攻撃パターン１つ
        
        ### EnemyBullet
        
        Bulletpool で実装することになると思われる。
        
        - 共通静的パラメータ
            - 寿命
            - 威力
            - 吸収可能エネルギー
        - 共通動的パラメータ
            - 消失フラグ-画面上から消失したかどうか。
            - 生存時間
        
- **UI**
    
    UIは自機のHPゲージ、ボスのHPゲージ、保持エネルギー量、保持特殊エネルギー数を表示。
    
    - 自機HPゲージ
        
        現在の自機の残りHP量を表すゲージ。
        
        画面上の左下に横たえる。
        
        残りHP量が{3割}を切ったら点滅する。そしてピコピコといったSEを鳴らす。
        
    - ボスHPゲージ
        
        ボスのHPゲージは複数ゲージからなる。
        
        画面上の右下、自機のHPゲージの横に横たえる。
        
        現在のゲージを大きくメインに配置。
        
        次以降のHPゲージをメインHPゲージ上方にサブHPゲージとして全て配置する。
        
        現在ゲージのHPを削り取ると次のゲージに移る。そのためサブHPゲージは数が減っていく。
        
    - 保持エネルギー量ゲージ
        
        画面左に縦配置したゲージ。
        
        このゲージは自機の現在保有しているエネルギー量を反映している。
        
        ゲージ上にはロボットの各攻撃アイコンが描写され、それぞれの使用エネルギー量の位置に置かれている。
        
    - 保持特殊エネルギー数アイコン
        
        保持特殊エネルギー数は保持エネルギー量ゲージのすぐ横に描写。
        
        現在所有している特殊エネルギーの量をアイコンの個数で表す。
        
    - ゲームオーバーUI
        
        フォーカス移動で以下の選択肢を選択可能
        
        - リトライ
        - ステージ選択に戻る
    - ポーズUI
        
        フォーカス移動で以下の選択肢を選択可能
        
        - 再開
        - リトライ
        - ステージ選択に戻る

## 入力周り

### フォーカス移動

UI上のボタンをフォーカス移動によって実装する。フォーカス移動は隣接した選択肢に対して可能。(詳細な仕様は未だ未定)

入力をし続けた場合、{0.5秒}のクールタイム後に入力方向にフォーカス移動を行う。その後も押されている場合は{0.2秒}毎に入力方向にフォーカス移動を行う

UIのフォーカス移動は以下によって行うことができる。

- 矢印キー(キーボード)
- WASD(キーボード)
- スティック(Xboxコントローラ)
- 十字キー(Xboxコントローラ)

### 基本UI入力

- 決定：Space / A
- キャンセル（閉じる・戻る）：ESC / B
- ポーズ：ESC / Start（またはMenu）

### 会話/紙芝居での入力

- 文章送り：Space / A

# セーブ/ロード

- jsonでデータ管理
- 各ステージクリア時と設定ウィンドウを閉じたときに保存

## 保存する情報

- ステージのアンロック状況
- 各ステージのクリアランク
- 設定情報